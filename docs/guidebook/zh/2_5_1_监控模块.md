# 监控模块
agentUniverse监控模块，主要围绕agent运行时的模型调用/token开销等进行数据追踪与记录。针对**目前框架已开放的模型调用追踪能力**，本文将详细介绍如何使用该功能。

## 监控配置
在agentUniverse的主配置文件`config.toml`中配置监控模块配置信息，如下：
```toml
[MONITOR]
activate = true
dir = './monitor'
```
- **`activate`**: 监控模块总开关，默认关闭，设置为true后将开启agent运行时的LLM调用追踪功能。
- **`dir`**: 监控模块对应的本地记录存储目录，默认为运行时，上一层级下的monitor目录，用户可自定义配置目录路径。

### 模型粒度配置
针对LLM调用追踪能力，agentUniverse同样支持模型粒度配置，当监控模块主开关打开后，可以通过LLM的yaml文件选择关闭特定模型调用追踪功能。

比如用户自定义的`demo_llm`模型，tracing设置为false，则关闭该模型的调用追踪功能。
```yaml
name: 'demo_llm'
description: 'demo openai'
model_name: 'gpt-4o'
max_tokens: 1000
max_retries: 2
tracing: false
metadata:
  type: 'LLM'
  module: 'agentuniverse.llm.default.default_openai_llm'
  class: 'DefaultOpenAILLM'
```
特别说明：agentUniverse主配置文件的监控模块总开关**优先级最高**，若activate配置为false的情况下，模型粒度配置不生效。

## 监控模块说明
### 模型调用追踪
用户若使用当前agentUniverse支持的**默认模型类**，则如上文所述配置完成后即可使用该功能。

#### trace_llm装饰器

若用户根据agentUniverse的模型基类LLM做自定义扩展，实现自定义模型调用，则需要在自定义模型类的调用方法call/acall中增加@trace_llm装饰器功能。

如下自定义模型示例代码：
```python
from typing import Any, Iterator, Union, AsyncIterator

from agentuniverse.llm.llm import LLM, LLMOutput
from agentuniverse.base.annotation.trace import trace_llm

class DemoLLM(LLM):

    @trace_llm
    def call(self, messages: list, **kwargs: Any) -> Union[LLMOutput, Iterator[LLMOutput]]:
        pass
    
    @trace_llm
    async def acall(self, *args: Any, **kwargs: Any) -> Union[LLMOutput, AsyncIterator[LLMOutput]]:
        pass
```
agentUniverse通过`@trace_llm`装饰器实现，agent在调用对应LLM call/acall方法时，采集模型prompt和response，将信息json序列化后存储到上文监控配置对应的本地存储目录下，以jsonl文件的形式按小时为单位分割。

#### 具体效果
调用agentUniverse sample工程中的demo_rag_agent，使用qwen-turbo模型，query为分析下巴菲特减持比亚迪的原因，模型调用追踪功能捕捉到的数据如下：
```json
{
  "source": "QWenOpenAIStyleLLM.acall", 
  "date": "2024-06-24 16:27:14", 
  "llm_input": 
    {"messages": [
      {
        "role": "system",
        "content": "你是一位精通信息分析的ai助手。\\n 你的目标是判断问题对应的答案是否提供了有价值的信息，并对问题的答案做出建议和评价"
      }, 
      {
        "role": "user",
        "content": "你需要遵守的规则是:\\n1. 必须使用中文结合查询的背景信息结合你所拥有的知识回答用户提出的问题。\\n2. 结构化答案生成，必要时通过空行提升阅读体验。\\n 需要回答的问题是: 分析下巴菲特减持比亚迪的原因\\n"
      }
    ]}, 
  "kwargs": {
    "model": "qwen-turbo", 
    "stream": false, 
    "n": 1, 
    "temperature": 0.5, 
    "max_tokens": 1000
  },
  "llm_output": "巴菲特减持比亚迪股票的原因可以从几个方面来分析：\\n\\n1. **投资策略调整**：尽管巴菲特通常倾向于长期持有优质股票，但投资组合管理需要灵活性。他可能会根据市场动态、行业趋势和个人评估的变化，适时调整持仓以优化资产配置或分散风险。\\n\\n2. **估值与预期回报**：减持可能反映了巴菲特对比亚迪当前股价与他内在价值评估的差距。尽管比亚迪业绩强劲，但如果他认为股价过高，可能会选择部分兑现利润。\\n 综上所述，巴菲特减持比亚迪股票可能是基于上述因素的综合考虑，但具体原因只有巴菲特和芒格本人了解。值得注意的是，尽管减持，他们对比亚迪的长期看好并未改变，这从芒格的演讲和持续的股东大会支持可以看出。"
}
```
- **`source`**: agent运行时LLM的调用来源
- **`date`**: LLM调用时间
- **`llm_input`**: LLM调用message及模型参数
- **`llm_output`**: LLM输出文本段信息